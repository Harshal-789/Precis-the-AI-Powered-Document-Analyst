<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Précis: Smart NLP Processor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary-color: #4f46e5; /* indigo-600 */
            --secondary-color: #10b981; /* emerald-500 */
            --accent-color: #f59e0b; /* amber-500 */
            --new-feature-color: #ec4899; /* pink-500 */
            --tertiary-color: #22d3ee; /* cyan-400 */ /* NEW COLOR */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 - Dark mode feel */
        }
        .summary-card {
            min-height: 200px;
            background-color: #1e293b; /* slate-800 */
            border-color: #334155; /* slate-700 */
            color: #f1f5f9; /* slate-100 */
        }
        .tab-content {
            display: none;
            transition: opacity 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
            opacity: 1;
        }
        .tab-button {
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            color: #94a3b8; /* slate-400 */
        }
        .tab-button.active {
            border-bottom-color: var(--primary-color);
            color: #e2e8f0; /* slate-200 */
            font-weight: 600;
        }
        .btn-base {
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: var(--secondary-color);
        }
        .btn-secondary:hover {
            background-color: #059669; /* emerald-600 */
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }
        .btn-accent {
            background-color: var(--accent-color);
        }
        .btn-accent:hover {
            background-color: #d97706; /* amber-600 */
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
            transform: translateY(-2px);
        }
        .btn-new-feature {
            background-color: var(--new-feature-color);
        }
        .btn-new-feature:hover {
            background-color: #db2777; /* pink-600 */
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.4);
            transform: translateY(-2px);
        }
        .btn-tertiary { /* NEW COLOR STYLES */
            background-color: var(--tertiary-color);
        }
        .btn-tertiary:hover {
            background-color: #06b6d4; /* cyan-600 */
            box-shadow: 0 6px 20px rgba(34, 211, 238, 0.4);
            transform: translateY(-2px);
        }
        /* Overriding input colors for dark mode */
        textarea, input[type=range], input[type=email], input[type=password] {
            background-color: #334155 !important; /* slate-700 */
            border-color: #475569 !important; /* slate-600 */
            color: #f1f5f9 !important;
        }
        input[type=range]::-webkit-slider-thumb {
            background: var(--primary-color);
            box-shadow: 0 0 5px rgba(79, 70, 229, 0.5);
        }
        .loader {
            border: 4px solid #334155;
            border-top: 4px solid #fff; 
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .history-item:hover {
            background-color: #334155; /* slate-700 */
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Main Application UI (Now loads immediately) -->
    <div id="mainApp" class="max-w-4xl mx-auto">
        <header class="text-center mb-10 relative">
            <h1 class="text-5xl font-extrabold text-white mb-2 flex items-center justify-center tracking-tight">
                <i data-lucide="sparkles" class="w-10 h-10 mr-3 text-indigo-400 animate-pulse"></i>
                Précis
            </h1>
            <p class="text-indigo-300 text-lg font-light">The AI-Powered Document Analyst</p>
        </header>

        <main class="space-y-8">
            <!-- Input Card -->
            <div class="bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700">
                <h2 class="text-2xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="file-text" class="w-5 h-5 mr-2 text-slate-400"></i>
                    Source Text
                </h2>
                <textarea id="inputText" rows="10" class="w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste your lengthy text here. Minimum 50 words required for analysis.">The quarterly project review meeting concluded with several critical decisions. First, the team agreed to postpone the deployment of the new search feature from October 25th to November 1st, citing incomplete integration testing. This delay is necessary to ensure stability. Second, Maria will be reallocating her time from front-end design mockups to debugging the core API service for the next two weeks, effective immediately. This is our top priority. Third, the marketing team is required to prepare a comprehensive report detailing the Q4 budget allocation, specifically justifying the increased spend on social media advertising versus traditional print. This report is due by the end of the business day on Friday. Finally, we must hire two new junior developers before the end of the year to support the growing backlog of feature requests. All department heads are to submit their final candidate requirements to HR by Wednesday. The overall strategic goal remains a 15% revenue increase by year-end.</textarea>
                <p id="wordCount" class="text-sm text-slate-400 mt-2 text-right">0 Words, 0 Sentences</p>
            </div>

            <!-- Controls and Parameters -->
            <div class="bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700">
                <h2 class="text-2xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="settings" class="w-5 h-5 mr-2 text-slate-400"></i>
                    AI Feature Controls
                </h2>
                <div class="mb-6">
                    <label for="summaryPercentage" class="block text-sm font-medium text-slate-300 mb-2">
                        Abstractive Summary Target Length: <span id="percentValue" class="font-bold text-indigo-400">4</span> Sentences
                    </label>
                    <input type="range" id="summaryPercentage" min="2" max="10" value="4" step="1" class="w-full">
                </div>

                <div id="buttonContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                    <button id="summarizeButton" class="btn-primary btn-base w-full px-4 py-3 text-white font-semibold rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 flex items-center justify-center disabled:opacity-50">
                        <div id="loadingIndicatorSummary" class="hidden loader mr-2"></div>
                        <i data-lucide="rocket" id="sparkleIconSummary" class="w-5 h-5 mr-2"></i>
                        <span id="buttonTextSummary">Summarize</span>
                    </button>

                    <button id="takeawaysButton" class="btn-secondary btn-base w-full px-4 py-3 text-white font-semibold rounded-lg focus:outline-none focus:ring-4 focus:ring-emerald-300 flex items-center justify-center disabled:opacity-50">
                        <div id="loadingIndicatorTakeaways" class="hidden loader mr-2"></div>
                        <i data-lucide="list-checks" id="sparkleIconTakeaways" class="w-5 h-5 mr-2"></i>
                        <span id="buttonTextTakeaways">Get Takeaways</span>
                    </button>

                    <button id="sentimentButton" class="btn-accent btn-base w-full px-4 py-3 text-white font-semibold rounded-lg focus:outline-none focus:ring-4 focus:ring-amber-300 flex items-center justify-center disabled:opacity-50">
                        <div id="loadingIndicatorSentiment" class="hidden loader mr-2"></div>
                        <i data-lucide="message-square" id="sparkleIconSentiment" class="w-5 h-5 mr-2"></i>
                        <span id="buttonTextSentiment">Analyze Sentiment</span>
                    </button>
                    
                    <button id="conceptButton" class="btn-new-feature btn-base w-full px-4 py-3 text-white font-semibold rounded-lg focus:outline-none focus:ring-4 focus:ring-pink-300 flex items-center justify-center disabled:opacity-50">
                        <div id="loadingIndicatorConcept" class="hidden loader mr-2"></div>
                        <i data-lucide="lightbulb" id="sparkleIconConcept" class="w-5 h-5 mr-2"></i>
                        <span id="buttonTextConcept">Concepts</span>
                    </button>

                    <!-- NEW BUTTON: Q&A Builder -->
                    <button id="faqButton" class="btn-tertiary btn-base w-full px-4 py-3 text-white font-semibold rounded-lg focus:outline-none focus:ring-4 focus:ring-cyan-300 flex items-center justify-center disabled:opacity-50">
                        <div id="loadingIndicatorFAQ" class="hidden loader mr-2"></div>
                        <i data-lucide="help-circle" id="sparkleIconFAQ" class="w-5 h-5 mr-2"></i>
                        <span id="buttonTextFAQ">Q&A Builder</span>
                    </button>
                </div>
                <p id="minWordRequirement" class="text-sm text-red-400 mt-3 hidden text-center">Please enter at least 50 words to enable AI features.</p>
            </div>

            <!-- Output Tabs and Content -->
            <div class="bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700">
                <div class="flex border-b border-slate-700 mb-4 overflow-x-auto">
                    <button id="tabSummary" class="tab-button active flex-1 py-3 text-sm flex items-center justify-center whitespace-nowrap" data-tab-id="summaryCard">
                        <i data-lucide="book-open-text" class="w-4 h-4 mr-2"></i> Summary
                    </button>
                    <button id="tabTakeaways" class="tab-button flex-1 py-3 text-sm flex items-center justify-center whitespace-nowrap" data-tab-id="takeawaysCard">
                        <i data-lucide="list-checks" class="w-4 h-4 mr-2"></i> Takeaways
                    </button>
                    <button id="tabSentiment" class="tab-button flex-1 py-3 text-sm flex items-center justify-center whitespace-nowrap" data-tab-id="sentimentCard">
                        <i data-lucide="message-square" class="w-4 h-4 mr-2"></i> Sentiment
                    </button>
                    <button id="tabConcept" class="tab-button flex-1 py-3 text-sm flex items-center justify-center whitespace-nowrap" data-tab-id="conceptCard">
                        <i data-lucide="lightbulb" class="w-4 h-4 mr-2"></i> Concepts
                    </button>
                    <!-- NEW TAB: Q&A -->
                    <button id="tabFAQ" class="tab-button flex-1 py-3 text-sm flex items-center justify-center whitespace-nowrap" data-tab-id="faqCard">
                        <i data-lucide="help-circle" class="w-4 h-4 mr-2"></i> Q&A
                    </button>
                    <button id="tabHistory" class="tab-button flex-1 py-3 text-sm flex items-center justify-center whitespace-nowrap" data-tab-id="historyCard">
                        <i data-lucide="history" class="w-4 h-4 mr-2"></i> History
                    </button>
                </div>

                <!-- 1. Output Card - Summary -->
                <div id="summaryCard" class="tab-content active">
                    <h2 class="text-xl font-semibold text-indigo-400 mb-4 flex items-center">
                        <i data-lucide="rocket" class="w-5 h-5 mr-2"></i> Abstractive Summary
                    </h2>
                    <div id="summaryOutput" class="summary-card p-4 rounded-lg border text-base whitespace-pre-wrap">
                        Click 'Summarize' to generate a human-like summary of the text.
                    </div>
                    <p id="summaryStats" class="text-sm text-slate-400 mt-2 text-right invisible">Summary: 0 Words, 0 Sentences</p>
                </div>
                
                <!-- 2. Output Card - Key Takeaways -->
                <div id="takeawaysCard" class="tab-content">
                    <h2 class="text-xl font-semibold text-emerald-400 mb-4 flex items-center">
                        <i data-lucide="list-checks" class="w-5 h-5 mr-2"></i> Key Takeaways & Action Points
                    </h2>
                    <ul id="takeawaysOutput" class="summary-card p-4 rounded-lg border text-base list-disc list-inside space-y-3">
                        <li>Key decisions and required actions will appear here in a structured, actionable format.</li>
                    </ul>
                    <p id="takeawaysStats" class="text-sm text-slate-400 mt-2 text-right invisible">Generated 0 Takeaways.</p>
                </div>
                
                <!-- 3. Output Card - Sentiment Analysis -->
                <div id="sentimentCard" class="tab-content">
                    <h2 class="text-xl font-semibold text-amber-400 mb-4 flex items-center">
                        <i data-lucide="message-square" class="w-5 h-5 mr-2"></i> Sentiment & Tone Analysis
                    </h2>
                    <div id="sentimentOutput" class="summary-card p-4 rounded-lg border text-base space-y-4">
                        <p id="overallSentiment" class="text-lg font-bold">Overall Sentiment: <span class="font-normal text-slate-400">Click 'Analyze Sentiment' to begin.</span></p>
                        <p id="toneKeywords">Tone Keywords: <span class="text-slate-400"></span></p>
                        <p id="justification" class="pt-2 border-t border-slate-700">Justification: <span class="text-slate-400 italic"></span></p>
                    </div>
                    <p id="sentimentStats" class="text-sm text-slate-400 mt-2 text-right invisible">Analysis Complete.</p>
                </div>
                
                <!-- 4. Output Card - Concept Extraction -->
                <div id="conceptCard" class="tab-content">
                    <h2 class="text-xl font-semibold text-pink-400 mb-4 flex items-center">
                        <i data-lucide="lightbulb" class="w-5 h-5 mr-2"></i> Concept Extraction & Definition
                    </h2>
                    <table id="conceptOutput" class="summary-card w-full rounded-lg border text-sm">
                        <thead class="bg-slate-700/50">
                            <tr>
                                <th class="p-3 text-left font-semibold">Concept/Term</th>
                                <th class="p-3 text-left font-semibold hidden sm:table-cell">Definition</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="2" class="p-4 text-center text-slate-400">Click 'Concepts' to extract and define key terms.</td></tr>
                        </tbody>
                    </table>
                    <p id="conceptStats" class="text-sm text-slate-400 mt-2 text-right invisible">Analysis Complete.</p>
                </div>

                <!-- 5. NEW Output Card - Q&A Generator -->
                <div id="faqCard" class="tab-content">
                    <h2 class="text-xl font-semibold text-cyan-400 mb-4 flex items-center">
                        <i data-lucide="help-circle" class="w-5 h-5 mr-2"></i> Q&A Builder
                    </center>
                    <table id="faqOutput" class="summary-card w-full rounded-lg border text-sm">
                        <thead class="bg-slate-700/50">
                            <tr>
                                <th class="p-3 text-left font-semibold w-1/3">Question</th>
                                <th class="p-3 text-left font-semibold w-2/3">Answer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="2" class="p-4 text-center text-slate-400">Click 'Q&A Builder' to generate an FAQ list.</td></tr>
                        </tbody>
                    </table>
                    <p id="faqStats" class="text-sm text-slate-400 mt-2 text-right invisible">Analysis Complete.</p>
                </div>

                <!-- 6. History Card -->
                <div id="historyCard" class="tab-content">
                    <h2 class="text-xl font-semibold text-slate-300 mb-4 flex items-center">
                        <i data-lucide="history" class="w-5 h-5 mr-2"></i> Analysis History
                    </h2>
                    <div id="historyOutput" class="summary-card p-4 rounded-lg border text-base space-y-3">
                        <p class="text-center text-slate-400" id="historyMessage">Loading your history...</p>
                        <ul id="historyList" class="divide-y divide-slate-700">
                            <!-- History items will be inserted here -->
                        </ul>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // IMPORT FIREBASE AUTH FOR ANONYMOUS SIGN IN
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level to Debug (Required by instructions)
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES & FIREBASE CONFIGURATION ---
        
        // Use a static appId for local running, since __app_id is unavailable
        const appId = 'precis-local-app'; 
        
        // Configuration for project 'precis-d7f1e' - used since Auth is removed.
        // This configuration object MUST be correct for the History feature to work.
        const firebaseConfig = {
            apiKey: "AIzaSyDDe2Yds1l5Pa2LAnlCnY8kPd3tJp8yhyA",
            authDomain: "precis-d7f1e.firebaseapp.com",
            projectId: "precis-d7f1e",
            storageBucket: "precis-d7f1e.firebasestorage.app",
            messagingSenderId: "244636790269",
            appId: "1:244636790269:web:ee7cde81b28748e8c33d94",
            measurementId: "G-WJWCQS8X72"
        };
        
        // Internal state
        let db;
        let auth; // Declare auth variable
        let currentUserId = null;
        let isAuthReady = false;

        // API Configuration
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        
        // *******************************************************************
        // VALID GEMINI API KEY INSERTED HERE
        // *******************************************************************
        const apiKey = "AIzaSyCRpcPnf-9Mn764oGtT95psSAus0vk6sAY"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        // Structured output schemas (Unchanged)
        const KEY_TAKEAWAYS_SCHEMA = {
            type: "ARRAY",
            description: "A list of 3 to 5 concise key takeaways or action items.",
            items: {
                type: "STRING",
                description: "A single, self-contained key point or action item from the text."
            }
        };

        const SENTIMENT_SCHEMA = {
            type: "OBJECT",
            properties: {
                overallSentiment: { type: "STRING", description: "The single dominant sentiment (e.g., Positive, Neutral, Negative, Urgent, Mixed)." },
                toneKeywords: { type: "ARRAY", items: { type: "STRING" }, description: "3-5 descriptive keywords capturing the document's tone (e.g., Formal, Critical, Optimistic, Decisive, Concerned)." },
                justification: { type: "STRING", description: "A brief, one-sentence justification for the overall sentiment." }
            },
            propertyOrdering: ["overallSentiment", "toneKeywords", "justification"]
        };
        
        const CONCEPT_SCHEMA = {
            type: "ARRAY",
            description: "A list of 3-7 key concepts or technical terms from the document with a concise definition for each.",
            items: {
                type: "OBJECT",
                properties: {
                    term: { type: "STRING" },
                    definition: { type: "STRING" }
                }
            }
        };

        // FAQ Schema (Unchanged)
        const FAQ_SCHEMA = {
            type: "ARRAY",
            description: "A list of 3 to 5 relevant questions and answers derived from the document.",
            items: {
                type: "OBJECT",
                properties: {
                    question: { type: "STRING", description: "A relevant question based on the document's content." },
                    answer: { type: "STRING", description: "A concise, direct answer to the question, based ONLY on the document." }
                }
            }
        };


        // --- FIREBASE INITIALIZATION ---
        
        // Check if configuration exists
        if (firebaseConfig && firebaseConfig.projectId) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app); // Initialize Auth service

            // 1. Sign in ANONYMOUSLY to get a valid request.auth object for Firestore rules
            signInAnonymously(auth).then((userCredential) => {
                // 2. Use the authenticated user's UID as the currentUserId
                currentUserId = userCredential.user.uid; 
                isAuthReady = true;

                console.log("App Initialized. Anonymous User ID:", currentUserId);
                loadHistory();

            }).catch(error => {
                console.error("Firebase Anonymous Sign-In Failed:", error);
                let message = "ERROR: Failed to initialize history. Please check Firebase Console.";
                if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
                    message = "ERROR: Anonymous Sign-In is DISABLED. Go to Firebase Auth -> Sign-in method and ENABLE 'Anonymous'.";
                }
                document.getElementById('historyMessage').textContent = message;
                currentUserId = 'anonymous-error-user';
                isAuthReady = true;
            });
            
        } else {
            console.error("Firebase configuration is missing or invalid. History features will be non-functional.");
            currentUserId = 'anonymous-error-user';
            isAuthReady = true;
        }

        // --- UTILITY FUNCTIONS ---
        function countSentences(text) {
            return (text.match(/[^.!?]+[.!?]+/g) || []).length;
        }
        
        function countWords(text) {
            return text.split(/\s+/).filter(w => w.length > 0).length;
        }

        // Firestore path helper
        function getUserHistoryCollection() {
            if (!currentUserId || !db) return null;
            // Private data path: /artifacts/{appId}/users/{userId}/{collectionName}
            // Using the static appId 'precis-local-app' here.
            return collection(db, `artifacts/${appId}/users/${currentUserId}/analyses`);
        }

        // --- HISTORY MANAGEMENT ---

        async function saveHistory(input, analysis) {
            if (!isAuthReady || !currentUserId) {
                console.warn("History not saved: App not ready or anonymous user ID is missing.");
                return;
            }
            
            const historyCollection = getUserHistoryCollection();
            if (!historyCollection) return;

            try {
                // Check if any analysis field is populated
                if (analysis.summary || analysis.takeaways || analysis.sentiment || analysis.concepts || analysis.faq) {
                    const historyData = {
                        input: input,
                        summary: analysis.summary || null,
                        takeaways: analysis.takeaways || null,
                        sentiment: analysis.sentiment || null,
                        concepts: analysis.concepts || null,
                        faq: analysis.faq || null, 
                        timestamp: serverTimestamp()
                    };
                    
                    await addDoc(historyCollection, historyData);
                    console.log("Analysis saved to history (Anonymous Session).");
                } else {
                    console.log("No complete analysis data to save.");
                }
            } catch (error) {
                console.error("Error saving history:", error);
            }
        }

        function loadHistory() {
            if (!isAuthReady || !currentUserId || !db) {
                document.getElementById('historyMessage').textContent = "History is unavailable due to configuration errors.";
                return;
            }

            const historyCollection = getUserHistoryCollection();
            if (!historyCollection) return;

            // Sort by timestamp descending
            const q = query(historyCollection, orderBy("timestamp", "desc"));
            const historyList = document.getElementById('historyList');
            const historyMessage = document.getElementById('historyMessage');

            historyMessage.textContent = "Fetching past analyses (current session)...";
            historyList.innerHTML = '';

            onSnapshot(q, (snapshot) => {
                historyList.innerHTML = '';
                if (snapshot.empty) {
                    historyMessage.textContent = "No past analyses found for this session. Run a feature to save your first one!";
                    return;
                }
                
                // Collect documents to pass to attachHistoryLoadListeners
                const docs = [];
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    docs.push({ id: doc.id, data: data });

                    const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                    const snippet = data.input.substring(0, 70) + (data.input.length > 70 ? '...' : '');

                    const li = document.createElement('li');
                    li.className = 'history-item p-3 rounded-lg flex justify-between items-center transition duration-150';
                    li.innerHTML = `
                        <div>
                            <p class="font-medium text-slate-200">${snippet}</p>
                            <p class="text-xs text-slate-400 mt-1">Analyzed on: ${date}</p>
                        </div>
                        <button class="text-indigo-400 hover:text-indigo-300 text-sm flex items-center ml-4 load-history-btn" data-id="${doc.id}">
                            Load
                            <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                        </button>
                    `;
                    historyList.appendChild(li);
                });
                historyMessage.textContent = snapshot.size > 0 ? "Click 'Load' to view a past analysis." : "No past analyses found.";
                lucide.createIcons(); // Re-render icons
                attachHistoryLoadListeners(docs);
            }, (error) => {
                // This is the error handler that catches the "Missing or insufficient permissions"
                console.error("Error listening to history:", error);
                historyMessage.textContent = `Error loading history data: ${error.message}. Please check Firestore rules and browser console for details.`;
            });
        }

        function attachHistoryLoadListeners(docs) {
            document.querySelectorAll('.load-history-btn').forEach(button => {
                button.onclick = () => {
                    const id = button.getAttribute('data-id');
                    // Find the data object corresponding to the button ID
                    const data = docs.find(d => d.id === id)?.data;
                    if (data) {
                        loadPreviousAnalysis(data);
                    }
                };
            });
        }

        // Function to populate the UI with loaded history data
        function loadPreviousAnalysis(data) {
            // Must clear first to handle the auto-clear logic on updateStats
            clearOutputPanels(); 
            
            // 1. Update Input Area
            inputTextarea.value = data.input;
            
            // 2. Update Summary Tab
            if (data.summary) {
                switchTab('summaryCard');
                summaryOutput.textContent = data.summary;
                summaryStats.textContent = `Summary: ${countWords(data.summary)} Words, ${countSentences(data.summary)} Sentences (Source: History)`;
                summaryStats.classList.remove('invisible');
            }

            // 3. Update Takeaways Tab
            if (data.takeaways && Array.isArray(data.takeaways)) {
                switchTab('takeawaysCard');
                takeawaysOutput.innerHTML = '';
                data.takeaways.forEach(point => {
                    const li = document.createElement('li');
                    li.textContent = point;
                    takeawaysOutput.appendChild(li);
                });
                takeawaysStats.textContent = `Generated ${data.takeaways.length} Takeaways (Source: History).`;
                takeawaysStats.classList.remove('invisible');
            }

            // 4. Update Sentiment Tab
            if (data.sentiment) {
                switchTab('sentimentCard');
                const sentiment = data.sentiment;
                const getColor = (s) => {
                    if (s && (s.toLowerCase().includes('positive') || s.toLowerCase().includes('optimistic'))) return 'text-emerald-400';
                    if (s && (s.toLowerCase().includes('negative') || s.toLowerCase().includes('critical'))) return 'text-red-400';
                    if (s && (s.toLowerCase().includes('urgent') || s.toLowerCase().includes('decisive'))) return 'text-amber-400';
                    return 'text-indigo-400';
                };
                
                document.getElementById('sentimentOutput').innerHTML = `
                    <p id="overallSentiment" class="text-lg font-bold">Overall Sentiment: 
                        <span class="font-normal ${getColor(sentiment.overallSentiment)}">${sentiment.overallSentiment || 'N/A'}</span>
                    </p>
                    <p id="toneKeywords">Tone Keywords: 
                        <span class="text-slate-300">${(sentiment.toneKeywords || []).join(', ')}</span>
                    </p>
                    <p id="justification" class="pt-2 border-t border-slate-700">Justification: 
                        <span class="text-slate-400 italic">${sentiment.justification || 'N/A'}</span>
                    </p>
                `;
                sentimentStats.classList.remove('invisible');
            }
            
            // 5. Update Concepts Tab
            if (data.concepts && Array.isArray(data.concepts)) {
                switchTab('conceptCard');
                const tbody = document.querySelector('#conceptOutput tbody');
                tbody.innerHTML = '';
                data.concepts.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.className = index % 2 === 0 ? 'bg-slate-800' : 'bg-slate-700/50';
                    tr.innerHTML = `
                        <td class="p-3 font-medium">${item.term}</td>
                        <td class="p-3 text-slate-400 hidden sm:table-cell">${item.definition}</td>
                    `;
                    tbody.appendChild(tr);
                });
                conceptStats.textContent = `Generated ${data.concepts.length} Concepts (Source: History).`;
                conceptStats.classList.remove('invisible');
            }
            
            // 6. NEW: Update Q&A Tab
            if (data.faq && Array.isArray(data.faq)) {
                switchTab('faqCard');
                const tbody = document.querySelector('#faqOutput tbody');
                tbody.innerHTML = '';
                data.faq.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.className = index % 2 === 0 ? 'bg-slate-800' : 'bg-slate-700/50';
                    tr.innerHTML = `
                        <td class="p-3 font-medium text-slate-200">${item.question}</td>
                        <td class="p-3 text-slate-400">${item.answer}</td>
                    `;
                    tbody.appendChild(tr);
                });
                faqStats.textContent = `Generated ${data.faq.length} Q&A Pairs (Source: History).`;
                faqStats.classList.remove('invisible');
            }

            // Final switch to the History tab and update source text stats
            switchTab('historyCard');
            updateStats();
        }

        // --- DOM Elements & Loading State ---
        const inputTextarea = document.getElementById('inputText');
        const summaryPercentage = document.getElementById('summaryPercentage');
        const percentValueSpan = document.getElementById('percentValue');
        const summarizeButton = document.getElementById('summarizeButton');
        const takeawaysButton = document.getElementById('takeawaysButton');
        const sentimentButton = document.getElementById('sentimentButton');
        const conceptButton = document.getElementById('conceptButton');
        const faqButton = document.getElementById('faqButton'); // NEW BUTTON ELEMENT
        const summaryOutput = document.getElementById('summaryOutput');
        const takeawaysOutput = document.getElementById('takeawaysOutput');
        const summaryStats = document.getElementById('summaryStats');
        const takeawaysStats = document.getElementById('takeawaysStats');
        const sentimentStats = document.getElementById('sentimentStats');
        const conceptStats = document.getElementById('conceptStats');
        const faqOutput = document.getElementById('faqOutput'); // NEW OUTPUT ELEMENT
        const faqStats = document.getElementById('faqStats'); // NEW STATS ELEMENT
        const minWordRequirement = document.getElementById('minWordRequirement');
        
        // Map button IDs to their respective suffix for dynamic element lookup
        const buttonSuffixMap = {
            'summarizeButton': 'Summary',
            'takeawaysButton': 'Takeaways',
            'sentimentButton': 'Sentiment',
            'conceptButton': 'Concept',
            'faqButton': 'FAQ' // NEW MAP ENTRY
        };

        // Utility for setting loading state
        function setLoadingState(buttonId, isLoading) {
            const suffix = buttonSuffixMap[buttonId];
            if (!suffix) return;

            const button = document.getElementById(buttonId);
            const sparkleIcon = document.getElementById(`sparkleIcon${suffix}`);
            const loadingIndicator = document.getElementById(`loadingIndicator${suffix}`);
            const buttonText = document.getElementById(`buttonText${suffix}`);

            if (!button || !sparkleIcon || !loadingIndicator || !buttonText) {
                console.error(`setLoadingState failed: Could not find all elements for ${buttonId}.`);
                return;
            }

            // Disable all buttons during generation
            const allButtons = [summarizeButton, takeawaysButton, sentimentButton, conceptButton, faqButton];
            allButtons.forEach(btn => btn.disabled = isLoading);

            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                sparkleIcon.classList.add('hidden');
                buttonText.textContent = 'Analyzing...';
            } else {
                loadingIndicator.classList.add('hidden');
                sparkleIcon.classList.remove('hidden');
                
                // Reset button text
                if (buttonId === 'summarizeButton') {
                    buttonText.textContent = 'Summarize';
                } else if (buttonId === 'takeawaysButton') {
                    buttonText.textContent = 'Get Takeaways';
                } else if (buttonId === 'sentimentButton') {
                    buttonText.textContent = 'Analyze Sentiment';
                } else if (buttonId === 'conceptButton') {
                    buttonText.textContent = 'Concepts';
                } else if (buttonId === 'faqButton') { // NEW BUTTON TEXT RESET
                    buttonText.textContent = 'Q&A Builder';
                }
            }

            // Re-enable if minimum word count is met and not currently loading
            const words = countWords(inputTextarea.value.trim());
            const isReady = words >= 50;
            if (!isLoading && isReady) {
                allButtons.forEach(btn => btn.disabled = false);
            } else if (!isReady) {
                allButtons.forEach(btn => btn.disabled = true);
            }
        }

        // Core Gemini API Call Function (Unchanged logic)
        async function callGeminiAPI(userQuery, systemPrompt, buttonId, schema = null) {
            setLoadingState(buttonId, true);
            
            let payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }

            try {
                for (let attempt = 0; attempt < 5; attempt++) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; 
                    }

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API returned status ${response.status}: ${response.statusText}. Response body: ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (schema) {
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) {
                            return JSON.parse(jsonText);
                        } else {
                            throw new Error("API response was valid but contained no generated JSON.");
                        }
                    } else {
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            return text;
                        } else {
                            throw new Error("API response was valid but contained no generated text.");
                        }
                    }
                }
            } catch (error) {
                console.error("API call error:", error);
                throw error;
            } finally {
                setLoadingState(buttonId, false);
            }
            
            throw new Error("API call failed after multiple retries.");
        }


        // --- FEATURE HANDLERS ---

        let currentAnalysisResults = {}; // Object to hold the latest results for history saving

        async function handleSummarize() {
            switchTab('summaryCard');
            const rawText = inputTextarea.value.trim();
            const targetSentences = parseInt(summaryPercentage.value);
            
            summaryOutput.textContent = "Processing and analyzing text with AI...";
            summaryStats.classList.add('invisible');

            const userQuery = `Please generate a concise, high-quality, abstractive summary of the following document. The summary must be exactly ${targetSentences} sentences long. Document: ${rawText}`;
            const systemPrompt = `You are an expert abstractive summarization tool. Your goal is to rephrase and condense the core concepts of the provided text into a fluent, cohesive summary that captures the main idea without repeating exact sentences from the source. Your summary MUST adhere to the requested sentence count.`;

            try {
                const summary = await callGeminiAPI(userQuery, systemPrompt, 'summarizeButton');
                
                summaryOutput.textContent = summary;

                const summaryWords = countWords(summary);
                const summarySentences = countSentences(summary);

                summaryStats.textContent = `Summary: ${summaryWords} Words, ${summarySentences} Sentences (Target: ${targetSentences})`;
                summaryStats.classList.remove('invisible');

                currentAnalysisResults.summary = summary;
                // Save history only if authenticated
                if (currentUserId) saveHistory(rawText, currentAnalysisResults);
                
            } catch (error) {
                summaryOutput.textContent = `Error: Could not generate summary. ${error.message}`;
            }
        }
        
        async function handleKeyTakeaways() {
            switchTab('takeawaysCard');
            const rawText = inputTextarea.value.trim();
            
            takeawaysOutput.innerHTML = '<li>Processing and analyzing text with AI...</li>';
            takeawaysStats.classList.add('invisible');

            const userQuery = `Analyze the following text and extract 3 to 5 key takeaways and action points. Provide them in a list format. Document: ${rawText}`;
            const systemPrompt = `You are a critical analysis and action item extractor. Based on the input text, you must identify the most important decisions, deadlines, or required actions and format them into a list using the provided JSON schema. Ensure each point is actionable or critical.`;

            try {
                const takeawaysArray = await callGeminiAPI(userQuery, systemPrompt, 'takeawaysButton', KEY_TAKEAWAYS_SCHEMA);
                
                takeawaysOutput.innerHTML = '';
                if (Array.isArray(takeawaysArray) && takeawaysArray.length > 0) {
                    takeawaysArray.forEach(point => {
                        const li = document.createElement('li');
                        li.textContent = point;
                        takeawaysOutput.appendChild(li);
                    });
                } else {
                    takeawaysOutput.innerHTML = '<li>Analysis returned no key takeaways or failed to parse the structured list.</li>';
                }

                takeawaysStats.textContent = `Generated ${takeawaysArray.length || 0} Takeaways.`;
                takeawaysStats.classList.remove('invisible');

                currentAnalysisResults.takeaways = takeawaysArray;
                if (currentUserId) saveHistory(rawText, currentAnalysisResults);
                
            } catch (error) {
                takeawaysOutput.innerHTML = `<li>Error: Could not generate takeaways. ${error.message}</li>`;
            }
        }

        async function handleSentimentAnalysis() {
            switchTab('sentimentCard');
            const rawText = inputTextarea.value.trim();

            const output = document.getElementById('sentimentOutput');
            output.innerHTML = `<p id="overallSentiment" class="text-lg font-bold text-slate-300">Overall Sentiment: <span class="font-normal text-slate-400">Analyzing tone...</span></p>`;
            sentimentStats.classList.add('invisible');
            
            const userQuery = `Perform a comprehensive sentiment and tone analysis on the following document. Document: ${rawText}`;
            const systemPrompt = `You are a professional sentiment and tone analyzer. You must provide a structured analysis using the provided JSON schema. Be accurate and concise.`;

            try {
                const analysis = await callGeminiAPI(userQuery, systemPrompt, 'sentimentButton', SENTIMENT_SCHEMA);
                
                const sentimentText = analysis.overallSentiment || 'N/A';
                const toneKeywords = (analysis.toneKeywords || []).join(', ');
                const justification = analysis.justification || 'No justification provided.';

                const getColor = (s) => {
                    if (s && (s.toLowerCase().includes('positive') || s.toLowerCase().includes('optimistic'))) return 'text-emerald-400';
                    if (s && (s.toLowerCase().includes('negative') || s.toLowerCase().includes('critical'))) return 'text-red-400';
                    if (s && (s.toLowerCase().includes('urgent') || s.toLowerCase().includes('decisive'))) return 'text-amber-400';
                    return 'text-indigo-400';
                };

                output.innerHTML = `
                    <p id="overallSentiment" class="text-lg font-bold">Overall Sentiment: 
                        <span class="font-normal ${getColor(sentimentText)}">${sentimentText}</span>
                    </p>
                    <p id="toneKeywords">Tone Keywords: 
                        <span class="text-slate-300">${toneKeywords}</span>
                    </p>
                    <p id="justification" class="pt-2 border-t border-slate-700">Justification: 
                        <span class="text-slate-400 italic">${justification}</span>
                    </p>
                `;

                sentimentStats.classList.remove('invisible');
                
                currentAnalysisResults.sentiment = analysis;
                if (currentUserId) saveHistory(rawText, currentAnalysisResults);

            } catch (error) {
                output.innerHTML = `<p class="text-red-400">Error: Could not perform sentiment analysis. ${error.message}</p>`;
            }
        }
        
        async function handleConceptExtraction() {
            switchTab('conceptCard');
            const rawText = inputTextarea.value.trim();
            
            const tbody = document.querySelector('#conceptOutput tbody');
            tbody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-slate-400">Processing and analyzing text with AI...</td></tr>';
            conceptStats.classList.add('invisible');
            
            const userQuery = `Extract the 3 to 7 most important technical or key concepts from the following document and provide a concise, single-sentence definition for each. Document: ${rawText}`;
            const systemPrompt = `You are an expert concept extractor and definer. You must analyze the text and return a list of key concepts and their definitions using the provided JSON schema.`;

            try {
                const conceptsArray = await callGeminiAPI(userQuery, systemPrompt, 'conceptButton', CONCEPT_SCHEMA);
                
                tbody.innerHTML = '';
                if (Array.isArray(conceptsArray) && conceptsArray.length > 0) {
                    conceptsArray.forEach((item, index) => {
                        const tr = document.createElement('tr');
                        tr.className = index % 2 === 0 ? 'bg-slate-800' : 'bg-slate-700/50';
                        tr.innerHTML = `
                            <td class="p-3 font-medium">${item.term}</td>
                            <td class="p-3 text-slate-400 hidden sm:table-cell">${item.definition}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-red-400">Analysis returned no concepts or failed to parse the structured list.</td></tr>';
                }

                conceptStats.textContent = `Generated ${conceptsArray.length || 0} Concepts.`;
                conceptStats.classList.remove('invisible');
                
                currentAnalysisResults.concepts = conceptsArray;
                if (currentUserId) saveHistory(rawText, currentAnalysisResults);

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-red-400">Error: Could not generate concepts. ${error.message}</td></tr>`;
            }
        }
        
        // Handler for Q&A Generation (Unchanged logic)
        async function handleFAQGeneration() {
            switchTab('faqCard');
            const rawText = inputTextarea.value.trim();
            
            const tbody = document.querySelector('#faqOutput tbody');
            tbody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-slate-400">Processing and analyzing text with AI...</td></tr>';
            faqStats.classList.add('invisible');
            
            const userQuery = `Analyze the following document and generate 3 to 5 relevant Questions and their corresponding Answers, based ONLY on the provided text. Document: ${rawText}`;
            const systemPrompt = `You are an expert Q&A generator. Your goal is to create highly specific, concise, and useful question/answer pairs from the input text using the provided JSON schema. Ensure both the question and answer are directly relevant to the document content.`;

            try {
                const faqArray = await callGeminiAPI(userQuery, systemPrompt, 'faqButton', FAQ_SCHEMA);
                
                tbody.innerHTML = '';
                if (Array.isArray(faqArray) && faqArray.length > 0) {
                    faqArray.forEach((item, index) => {
                        const tr = document.createElement('tr');
                        tr.className = index % 2 === 0 ? 'bg-slate-800' : 'bg-slate-700/50';
                        tr.innerHTML = `
                            <td class="p-3 font-medium text-slate-200">${item.question}</td>
                            <td class="p-3 text-slate-400">${item.answer}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-red-400">Analysis returned no Q&A pairs or failed to parse the structured list.</td></tr>';
                }

                faqStats.textContent = `Generated ${faqArray.length || 0} Q&A Pairs.`;
                faqStats.classList.remove('invisible');
                
                currentAnalysisResults.faq = faqArray; // Save result
                if (currentUserId) saveHistory(rawText, currentAnalysisResults);

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-red-400">Error: Could not generate Q&A. ${error.message}</li>`;
            }
        }


        // --- UI/UX and Dynamic Navigation ---
        
        function switchTab(targetId) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            const activeTabButton = document.querySelector(`.tab-button[data-tab-id="${targetId}"]`);
            if (activeTabButton) activeTabButton.classList.add('active');

            const activeContent = document.getElementById(targetId);
            if (activeContent) activeContent.classList.add('active');
        }

        function setupTabListeners() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const targetId = event.currentTarget.getAttribute('data-tab-id');
                    switchTab(targetId);
                });
            });
        }
        
        // Function to clear all output panels (Unchanged logic)
        function clearOutputPanels() {
            // Reset state object
            currentAnalysisResults = {};

            // Clear Summary
            summaryOutput.textContent = "Click 'Summarize' to generate a human-like summary of the text.";
            summaryStats.classList.add('invisible');

            // Clear Takeaways
            takeawaysOutput.innerHTML = '<li>Key decisions and required actions will appear here in a structured, actionable format.</li>';
            takeawaysStats.classList.add('invisible');

            // Clear Sentiment
            document.getElementById('sentimentOutput').innerHTML = `<p id="overallSentiment" class="text-lg font-bold">Overall Sentiment: <span class="font-normal text-slate-400">Click 'Analyze Sentiment' to begin.</span></p><p id="toneKeywords">Tone Keywords: <span class="text-slate-400"></span></p><p id="justification" class="pt-2 border-t border-slate-700">Justification: <span class="text-slate-400 italic"></span></p>`;
            sentimentStats.classList.add('invisible');
            
            // Clear Concepts
            document.querySelector('#conceptOutput tbody').innerHTML = '<tr><td colspan="2" class="p-4 text-center text-slate-400">Click \'Concepts\' to extract and define key terms.</td></tr>';
            conceptStats.classList.add('invisible');

            // Clear Q&A
            document.querySelector('#faqOutput tbody').innerHTML = '<tr><td colspan="2" class="p-4 text-center text-slate-400">Click \'Q&A Builder\' to generate an FAQ list.</td></tr>';
            faqStats.classList.add('invisible');
        }


        // --- DOM Interaction and Event Listeners ---

        function updateStats() {
            const text = inputTextarea.value.trim();
            const words = countWords(text);
            const sentences = countSentences(text);

            wordCount.textContent = `${words} Words, ${sentences} Sentences`;
            
            const isReady = words >= 50;
            const actionText = isReady ? 'Summarize' : 'Minimum 50 words required';
            
            summarizeButton.disabled = !isReady;
            takeawaysButton.disabled = !isReady;
            sentimentButton.disabled = !isReady;
            conceptButton.disabled = !isReady;
            faqButton.disabled = !isReady; 
            
            minWordRequirement.classList.toggle('hidden', isReady);

            document.getElementById('buttonTextSummary').textContent = isReady ? 'Summarize' : actionText;
            document.getElementById('buttonTextTakeaways').textContent = isReady ? 'Get Takeaways' : actionText;
            document.getElementById('buttonTextSentiment').textContent = isReady ? 'Analyze Sentiment' : actionText;
            document.getElementById('buttonTextConcept').textContent = isReady ? 'Concepts' : actionText;
            document.getElementById('buttonTextFAQ').textContent = isReady ? 'Q&A Builder' : actionText;

            // Clear outputs immediately when user starts typing new data
            if (inputTextarea.dataset.lastInput !== text) {
                clearOutputPanels();
            }
            inputTextarea.dataset.lastInput = text;
        }

        // Initialize listeners
        inputTextarea.addEventListener('input', updateStats);
        summaryPercentage.addEventListener('input', () => {
            percentValueSpan.textContent = summaryPercentage.value;
        });

        summarizeButton.addEventListener('click', handleSummarize);
        takeawaysButton.addEventListener('click', handleKeyTakeaways);
        sentimentButton.addEventListener('click', handleSentimentAnalysis);
        conceptButton.addEventListener('click', handleConceptExtraction);
        faqButton.addEventListener('click', handleFAQGeneration); 

        // Initial setup
        updateStats(); 
        setupTabListeners();
    </script>
</body>
</html>
